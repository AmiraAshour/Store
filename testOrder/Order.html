<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Create Order & Pay</title>
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        form {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        
        label {
            display: block;
            margin-top: 10px;
        }
        
        input {
            width: 100%;
            padding: 8px;
            margin-top: 4px;
        }
        
        button {
            margin-top: 15px;
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
        
        #payment-form {
            display: none;
        }
    </style>
</head>

<body>

    <h2>Create Order</h2>
    <form id="order-form">
        <label>Delivery Method ID</label>
        <input type="number" id="deliveryMethodId">

        <label>Basket ID</label>
        <input type="text" id="basketId">

        <h3>Shipping Address</h3>
        <label>First Name</label>
        <input type="text" id="firstName">

        <label>Last Name</label>
        <input type="text" id="lastName">

        <label>City</label>
        <input type="text" id="city">

        <label>Zip Code</label>
        <input type="text" id="zipCode">

        <label>Street</label>
        <input type="text" id="street">

        <label>State</label>
        <input type="text" id="state">

        <button type="submit">Submit Order</button>
    </form>

    <h2>Payment</h2>
    <form id="payment-form">
        <div id="card-element">
            <!--Stripe.js injects the Card UI-->
        </div>
        <button id="submit">Pay</button>
        <div id="payment-result"></div>
    </form>

    <script>
        const stripe = Stripe("pk_test_12345"); // استبدليها بمفتاح publishable key من Stripe

        const orderForm = document.getElementById("order-form");
        const paymentForm = document.getElementById("payment-form");

        let clientSecret = null; // هنا هنخزن secret اللي بيرجع من السيرفر

        // 📌 Step 1: Create Order
        orderForm.addEventListener("submit", async(e) => {
            e.preventDefault();

            const orderData = {
                deliveryMethodId: document.getElementById("deliveryMethodId").value,
                basketId: document.getElementById("basketId").value,
                shipAddress: {
                    firstName: document.getElementById("firstName").value,
                    lastName: document.getElementById("lastName").value,
                    city: document.getElementById("city").value,
                    zipCode: document.getElementById("zipCode").value,
                    street: document.getElementById("street").value,
                    state: document.getElementById("state").value
                }
            };

            try {
                const response = await fetch("http://localhost:5031/api/orders", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    credentials: "include", // مهم علشان الكوكي يترجع من السيرفر
                    body: JSON.stringify({ // 👈 لازم JSON.stringify
                        deliveryMethodId: 1,
                        basketId: "user2",
                        shipAddress: {
                            firstName: "Amira",
                            lastName: "Ashour",
                            city: "Bani Mazer",
                            zipCode: "521",
                            street: "Shaihk Fadl",
                            state: "Minya"
                        }
                    })
                });

                console.log(response);
                const data = await response.json();
                clientSecret = data.clientSecret; // السيرفر بيرجع clientSecret بتاع الدفع

                alert("Order created successfully!");
                localStorage.setItem("orderId", data.data.id); // خزن orderId علشان تستخدمه في صفحة الدفع
                location.href = "payment.html"; // بعد ما الأوردر يتعمل، روح لصفحة الدفع

            } catch (err) {
                console.error(err);
                alert("Error connecting to server");
            }
            // هنا المفروض تستدعي API بتاعتك اللي تعمل الأوردر وترجع clientSecret من السيرفر

        });

        // 📌 Step 2: Payment
        const elements = stripe.elements();
        const cardElement = elements.create("card");
        cardElement.mount("#card-element");

        paymentForm.addEventListener("submit", async(e) => {
            e.preventDefault();

            const {
                paymentIntent,
                error
            } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement
                }
            });

            if (error) {
                document.getElementById("payment-result").innerText = error.message;
            } else if (paymentIntent.status === "succeeded") {
                document.getElementById("payment-result").innerText = "Payment Successful!";
            }
        });
    </script>
</body>

</html>