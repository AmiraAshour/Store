<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Payment</title>

    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <h1>Payment</h1>
    <button id="createIntent">Create Payment Intent</button>
    <button id="payNow">Pay Now (Test)</button>
    <div id="card-element"></div>
    <script>
        const baseUrl = "http://localhost:5031/api";
        const orderId = localStorage.getItem("orderId");

        if (!orderId) {
            //alert("No order found, please create an order first.");
            //  window.location.href = "order.html";
            orderId = 1002;
        }

        document.getElementById("createIntent").addEventListener("click", async function() {
            const res = await fetch(`${baseUrl}/payments/create-intent/${orderId}`, {
                method: "GET",
                credentials: "include",

            });

            const data = await res.json();
            console.log(data);
            alert("Payment Intent Created: " + data.data.clientSecret);

            localStorage.setItem("clientSecret", data.data.clientSecret);
            localStorage.setItem("paymentIntentId", data.data.paymentIntentId);
        });
        const stripe = Stripe("pk_test_51S0jTwL8IjdzdTf5iYyLiuzN1ubcfjZDgnn0tKzwxB14IkLgjzezHgTbdMtjrfufY0t4PgDwj7BBElUl9sZOvjxU00FcmLmKE2");

        const elements = stripe.elements();
        const cardElement = elements.create("card");
        cardElement.mount("#card-element");

        document.getElementById("payNow").addEventListener("click", async function() {
            let clientSecret = localStorage.getItem("clientSecret");
            let {
                error,
                paymentIntent
            } = await stripe.confirmCardPayment(clientSecret, {
                payment_method: {
                    card: cardElement,
                }
            });
            if (error) {
                console.error(error);
                alert("Payment failed: " + error.message);
                return;
            }
            const res = await fetch(`${baseUrl}/payments/pay-now-test`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify(orderId)

            });

            const data = await res.json();
            console.log(data);
            alert("Payment Status: " + data.data.status);
        });
    </script>
</body>

</html>